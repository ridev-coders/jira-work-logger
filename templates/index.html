<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Work Logger</title>

    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/favicon.png') }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">

    <!-- Bootstrap Icons CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <style>
        #calendar {
            margin: 20px auto;
            padding: 0 10px;
            height: 700px;
            /* Added fixed height */
        }
        
        .selected-time {
            background-color: #a8d5ff !important;
            cursor: pointer;
        }
        
        .submitted-time {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            cursor: not-allowed;
        }
        
        .submitted-time .fc-event-title {
            padding: 2px 4px;
        }
        
        .event-summary {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .fc-event-resizer {
            display: block !important;
            cursor: ns-resize;
        }
        
        .submitted-time .fc-event-resizer {
            display: none !important;
        }
        
        .delete-event {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            line-height: 14px;
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
            display: none;
        }
        
        .selected-time:hover .delete-event {
            display: block;
        }
        
        .submitted-time .delete-event {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1 class="text-center mt-4">Jira Work Logger</h1>

        <div class="row mt-4">
            <div class="col-md-2">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Calendar Settings</h5>
                        <div class="mb-3">
                            <label for="startTime" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime" value="08:00">
                        </div>
                        <div class="mb-3">
                            <label for="endTime" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime" value="19:00">
                        </div>
                        <div class="mb-3">
                            <label for="startDay" class="form-label">Start Day</label>
                            <select class="form-control" id="startDay">
                                <option value="0">Sunday</option>
                                <option value="1" selected>Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="endDay" class="form-label">End Day</label>
                            <select class="form-control" id="endDay">
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5" selected>Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="devMode">
                            <label class="form-check-label" for="devMode">
                                Developer Mode
                            </label>
                        </div>
                        <button type="button" class="btn btn-secondary w-100" id="manageCredentials">
                            Manage Credentials
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div id="calendar"></div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Log Work</h5>
                        <form id="workLogForm">
                            <div class="mb-3">
                                <label for="issueKey" class="form-label">Jira Issue Key</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="issueKey" required value="AI-152">
                                    <button type="button" class="btn btn-outline-secondary" id="viewIssueBtn">
                                        View Issue
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" id="submitWork">Submit Work Logs</button>
                                <button type="button" class="btn btn-danger" id="clearAll">Clear Unsubmitted</button>
                                <button type="button" class="btn btn-danger d-none" id="clearEverything">Clear All (Including Synced)</button>
                            </div>
                        </form>

                        <div class="event-summary mt-4">
                            <h6>Unsubmitted Time Slots</h6>
                            <div id="selectedEvents"></div>
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#submittedSummary" aria-expanded="false" aria-controls="submittedSummary">
                                Show Submitted Time Slots
                            </button>
                            <div class="collapse mt-2" id="submittedSummary">
                                <div class="card card-body">
                                    <div id="submittedEvents"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Success!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Work logs submitted successfully!</p>
                    <p>View the issue here:
                        <a id="issueLink" href="#" target="_blank"></a>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Credentials Modal -->
    <div class="modal fade" id="credentialsModal" tabindex="-1" aria-labelledby="credentialsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="credentialsModalLabel">Jira Credentials</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="credentialsForm" autocomplete="on">
                        <div class="mb-3">
                            <label for="jiraEmail" class="form-label">Jira Email</label>
                            <input type="email" class="form-control" id="jiraEmail" name="jiraEmail" autocomplete="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="jiraToken" class="form-label">API Token</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="jiraToken" name="jiraToken" autocomplete="current-password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleToken">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                Get your API token from <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">Atlassian API Tokens</a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="jiraInstance" class="form-label">Jira Instance URL</label>
                            <input type="text" class="form-control" id="jiraInstance" name="jiraInstance" placeholder="foundever.atlassian.net" value="foundever.atlassian.net" required>
                            <div class="form-text">
                                Your Jira instance URL (e.g., yourcompany.atlassian.net)
                            </div>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="rememberMe" name="rememberMe">
                            <label class="form-check-label" for="rememberMe">
                                Remember my credentials
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="clearCredentials">Clear Credentials</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveCredentials">Save Credentials</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedEvents = [];
            let submittedEvents = [];
            let devMode = false;

            const calendarEl = document.getElementById('calendar');
            let calendar;
            let credentialsModal;

            // Load saved time settings from localStorage
            function loadTimeSettings() {
                const savedStartTime = localStorage.getItem('workingHoursStart') || '08:00';
                const savedEndTime = localStorage.getItem('workingHoursEnd') || '19:00';
                const savedStartDay = localStorage.getItem('workingDayStart') || '1';
                const savedEndDay = localStorage.getItem('workingDayEnd') || '5';

                document.getElementById('startTime').value = savedStartTime;
                document.getElementById('endTime').value = savedEndTime;
                document.getElementById('startDay').value = savedStartDay;
                document.getElementById('endDay').value = savedEndDay;

                return {
                    startTime: savedStartTime + ':00',
                    endTime: savedEndTime + ':00',
                    startDay: parseInt(savedStartDay),
                    endDay: parseInt(savedEndDay)
                };
            }

            // Save time settings to localStorage
            function saveTimeSettings(startTime, endTime, startDay, endDay) {
                localStorage.setItem('workingHoursStart', startTime);
                localStorage.setItem('workingHoursEnd', endTime);
                localStorage.setItem('workingDayStart', startDay);
                localStorage.setItem('workingDayEnd', endDay);
            }

            // Save selected events to localStorage
            function saveSelectedEvents() {
                localStorage.setItem('selectedEvents', JSON.stringify(selectedEvents));
            }

            // Save submitted events to localStorage
            function saveSubmittedEvents() {
                localStorage.setItem('submittedEvents', JSON.stringify(submittedEvents));
            }

            // Load selected events from localStorage
            function loadSelectedEvents() {
                const savedEvents = localStorage.getItem('selectedEvents');
                if (savedEvents) {
                    const events = JSON.parse(savedEvents);
                    events.forEach(event => {
                        const isSubmitted = isEventSubmitted(event);
                        calendar.addEvent({
                            start: event.start,
                            end: event.end,
                            display: 'block',
                            backgroundColor: isSubmitted ? '#28a745' : '#a8d5ff',
                            borderColor: isSubmitted ? '#28a745' : '#a8d5ff',
                            classNames: isSubmitted ? ['submitted-time'] : ['selected-time'],
                            title: isSubmitted ? '✓ Synced with Jira' : '',
                            editable: false
                        });
                    });
                    selectedEvents = events;
                    updateEventSummary();
                }
            }

            // Load submitted events from localStorage
            function loadSubmittedEvents() {
                const savedSubmittedEvents = localStorage.getItem('submittedEvents');
                if (savedSubmittedEvents) {
                    submittedEvents = JSON.parse(savedSubmittedEvents);
                }
            }

            // Check if an event has been submitted
            function isEventSubmitted(event) {
                return submittedEvents.some(submittedEvent =>
                    submittedEvent.start === event.start &&
                    event.end === submittedEvent.end
                );
            }

            function initializeCalendar(startTime, endTime) {
                if (calendar) {
                    calendar.destroy();
                }

                const settings = loadTimeSettings();

                calendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'timeGridWeek,timeGridDay'
                    },
                    initialView: 'timeGridWeek',
                    slotMinTime: startTime,
                    slotMaxTime: endTime,
                    allDaySlot: false,
                    selectable: true,
                    selectMirror: true,
                    nowIndicator: true,
                    height: 'auto',
                    expandRows: true,
                    hiddenDays: [...Array(7).keys()].filter(day =>
                        day < settings.startDay || day > settings.endDay
                    ),
                    businessHours: {
                        daysOfWeek: [...Array(settings.endDay - settings.startDay + 1).keys()].map(x => x + settings.startDay),
                        startTime: startTime,
                        endTime: endTime,
                    },
                    scrollTime: startTime,
                    slotDuration: '00:30:00',
                    editable: true,
                    eventResizableFromStart: true,
                    eventDurationEditable: true,
                    eventStartEditable: false, // Prevent dragging, only allow resizing
                    eventResize: function(info) {
                        // Only allow resizing unsubmitted events
                        if (info.event.classNames.includes('submitted-time')) {
                            info.revert();
                            return;
                        }

                        // Update the event in selectedEvents
                        const index = selectedEvents.findIndex(e =>
                            e.start === info.oldEvent.startStr &&
                            e.end === info.oldEvent.endStr
                        );
                        if (index !== -1) {
                            selectedEvents[index] = {
                                start: info.event.startStr,
                                end: info.event.endStr,
                                display: 'block',
                                backgroundColor: '#a8d5ff',
                                borderColor: '#a8d5ff',
                                classNames: ['selected-time'],
                                title: '',
                                editable: true
                            };
                            saveSelectedEvents();
                            updateEventSummary();
                        }
                    },
                    eventDidMount: function(info) {
                        if (info.event.classNames.includes('selected-time')) {
                            info.el.style.backgroundColor = '#a8d5ff';
                            info.el.style.borderColor = '#a8d5ff';

                            // Add delete button for unsubmitted events
                            const deleteButton = document.createElement('div');
                            deleteButton.className = 'delete-event';
                            deleteButton.innerHTML = '×';
                            deleteButton.addEventListener('click', function(e) {
                                e.stopPropagation();
                                selectedEvents = selectedEvents.filter(event =>
                                    event.start !== info.event.startStr ||
                                    event.end !== info.event.endStr
                                );
                                info.event.remove();
                                saveSelectedEvents();
                                updateEventSummary();
                            });
                            info.el.appendChild(deleteButton);
                        } else if (info.event.classNames.includes('submitted-time')) {
                            info.el.style.backgroundColor = '#28a745';
                            info.el.style.borderColor = '#28a745';
                        }
                    },
                    select: function(info) {
                        const event = {
                            start: info.startStr,
                            end: info.endStr,
                            display: 'block',
                            backgroundColor: '#a8d5ff',
                            borderColor: '#a8d5ff',
                            classNames: ['selected-time'],
                            title: '',
                            editable: true
                        };
                        calendar.addEvent(event);
                        selectedEvents.push(event);
                        updateEventSummary();
                        saveSelectedEvents();
                    }
                });

                calendar.render();
                loadSelectedEvents();
            }

            // Load developer mode setting from localStorage
            function loadDevMode() {
                const savedDevMode = localStorage.getItem('devMode') === 'true';
                document.getElementById('devMode').checked = savedDevMode;
                devMode = savedDevMode;
                document.getElementById('clearEverything').classList.toggle('d-none', !devMode);
            }

            // Save developer mode setting to localStorage
            function saveDevMode(enabled) {
                localStorage.setItem('devMode', enabled);
                devMode = enabled;
                document.getElementById('clearEverything').classList.toggle('d-none', !enabled);
            }

            // Check if credentials are set
            async function checkCredentials() {
                try {
                    const response = await fetch('/api/check-credentials', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const result = await response.json();

                    if (!result.hasEnvCredentials) {
                        // No environment credentials, check for stored credentials
                        const email = localStorage.getItem('jiraEmail') || sessionStorage.getItem('jiraEmail');
                        const token = localStorage.getItem('jiraToken') || sessionStorage.getItem('jiraToken');

                        if (!email || !token) {
                            credentialsModal.show();
                        }
                    }
                } catch (error) {
                    console.error('Error checking credentials:', error);
                    credentialsModal.show();
                }
            }

            // Save credentials securely
            async function saveCredentials() {
                const email = document.getElementById('jiraEmail').value;
                const token = document.getElementById('jiraToken').value;
                const instance = document.getElementById('jiraInstance').value;
                const rememberMe = document.getElementById('rememberMe').checked;

                if (email && token && instance) {
                    // Save credentials without validation
                    if (rememberMe) {
                        // Only save in localStorage if user explicitly opts in
                        localStorage.setItem('jiraEmail', email);
                        localStorage.setItem('jiraToken', token);
                        localStorage.setItem('jiraInstance', instance);
                    } else {
                        // If not remembering, only keep in session
                        sessionStorage.setItem('jiraEmail', email);
                        sessionStorage.setItem('jiraToken', token);
                        sessionStorage.setItem('jiraInstance', instance);
                        // Clear any existing localStorage items
                        localStorage.removeItem('jiraEmail');
                        localStorage.removeItem('jiraToken');
                        localStorage.removeItem('jiraInstance');
                    }
                    credentialsModal.hide();
                } else {
                    alert('Please fill in all credential fields');
                }
            }

            // Initialize credentials modal
            function initializeCredentialsModal() {
                credentialsModal = new bootstrap.Modal(document.getElementById('credentialsModal'));

                // Load saved credentials if they exist
                const emailInput = document.getElementById('jiraEmail');
                const tokenInput = document.getElementById('jiraToken');
                const instanceInput = document.getElementById('jiraInstance');
                const rememberMeCheckbox = document.getElementById('rememberMe');

                // Try localStorage first, then sessionStorage
                const email = localStorage.getItem('jiraEmail') || sessionStorage.getItem('jiraEmail') || '';
                const token = localStorage.getItem('jiraToken') || sessionStorage.getItem('jiraToken') || '';
                const instance = localStorage.getItem('jiraInstance') || sessionStorage.getItem('jiraInstance') || 'foundever.atlassian.net';

                emailInput.value = email;
                tokenInput.value = token;
                instanceInput.value = instance;
                rememberMeCheckbox.checked = !!localStorage.getItem('jiraEmail');

                // Add event listeners
                document.getElementById('saveCredentials').addEventListener('click', saveCredentials);
                document.getElementById('manageCredentials').addEventListener('click', () => {
                    // Refresh credentials when modal is opened
                    emailInput.value = localStorage.getItem('jiraEmail') || sessionStorage.getItem('jiraEmail') || '';
                    tokenInput.value = localStorage.getItem('jiraToken') || sessionStorage.getItem('jiraToken') || '';
                    instanceInput.value = localStorage.getItem('jiraInstance') || sessionStorage.getItem('jiraInstance') || 'foundever.atlassian.net';
                    rememberMeCheckbox.checked = !!localStorage.getItem('jiraEmail');
                    tokenInput.type = 'password'; // Reset to password type
                    credentialsModal.show();
                });

                // Add toggle token visibility
                document.getElementById('toggleToken').addEventListener('click', function() {
                    const type = tokenInput.type === 'password' ? 'text' : 'password';
                    tokenInput.type = type;
                    this.innerHTML = `<i class="bi bi-eye${type === 'password' ? '' : '-slash'}"></i>`;
                });

                // Add clear credentials functionality
                document.getElementById('clearCredentials').addEventListener('click', function() {
                    if (confirm('Are you sure you want to clear your saved credentials?')) {
                        localStorage.removeItem('jiraEmail');
                        localStorage.removeItem('jiraToken');
                        localStorage.removeItem('jiraInstance');
                        sessionStorage.removeItem('jiraEmail');
                        sessionStorage.removeItem('jiraToken');
                        sessionStorage.removeItem('jiraInstance');
                        emailInput.value = '';
                        tokenInput.value = '';
                        instanceInput.value = 'foundever.atlassian.net';
                        rememberMeCheckbox.checked = false;
                        alert('Credentials cleared successfully');
                    }
                });
            }

            // Load saved settings and initialize calendar
            const savedTimes = loadTimeSettings();
            loadSubmittedEvents();
            loadDevMode();
            initializeCalendar(savedTimes.startTime, savedTimes.endTime);
            initializeCredentialsModal();
            checkCredentials();

            // Update time change listeners to save automatically
            document.getElementById('startTime').addEventListener('change', function() {
                const startTime = this.value;
                const endTime = document.getElementById('endTime').value;
                const startDay = document.getElementById('startDay').value;
                const endDay = document.getElementById('endDay').value;
                saveTimeSettings(startTime, endTime, startDay, endDay);
                initializeCalendar(startTime + ':00', endTime + ':00');
            });

            document.getElementById('endTime').addEventListener('change', function() {
                const startTime = document.getElementById('startTime').value;
                const endTime = this.value;
                const startDay = document.getElementById('startDay').value;
                const endDay = document.getElementById('endDay').value;
                saveTimeSettings(startTime, endTime, startDay, endDay);
                initializeCalendar(startTime + ':00', endTime + ':00');
            });

            // Add day range change listeners
            document.getElementById('startDay').addEventListener('change', function() {
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const startDay = this.value;
                const endDay = document.getElementById('endDay').value;

                if (parseInt(startDay) > parseInt(endDay)) {
                    alert('Start day cannot be after end day');
                    this.value = localStorage.getItem('workingDayStart') || '1';
                    return;
                }

                saveTimeSettings(startTime, endTime, startDay, endDay);
                initializeCalendar(startTime + ':00', endTime + ':00');
            });

            document.getElementById('endDay').addEventListener('change', function() {
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const startDay = document.getElementById('startDay').value;
                const endDay = this.value;

                if (parseInt(startDay) > parseInt(endDay)) {
                    alert('End day cannot be before start day');
                    this.value = localStorage.getItem('workingDayEnd') || '5';
                    return;
                }

                saveTimeSettings(startTime, endTime, startDay, endDay);
                initializeCalendar(startTime + ':00', endTime + ':00');
            });

            // Add developer mode toggle listener
            document.getElementById('devMode').addEventListener('change', function() {
                saveDevMode(this.checked);
            });

            // Update clear unsubmitted functionality
            document.getElementById('clearAll').addEventListener('click', function() {
                const unsubmittedEvents = selectedEvents.filter(event => !isEventSubmitted(event));

                if (unsubmittedEvents.length === 0) {
                    alert('No unsubmitted time slots to clear');
                    return;
                }

                if (confirm('Are you sure you want to clear all unsubmitted time slots?')) {
                    // Remove unsubmitted events from the calendar
                    calendar.getEvents().forEach(event => {
                        if (event.classNames.includes('selected-time')) {
                            event.remove();
                        }
                    });

                    // Filter out unsubmitted events from selectedEvents
                    selectedEvents = selectedEvents.filter(event => isEventSubmitted(event));
                    saveSelectedEvents();
                    updateEventSummary();
                }
            });

            // Add clear everything button listener (dev mode)
            document.getElementById('clearEverything').addEventListener('click', function() {
                if (selectedEvents.length === 0) {
                    alert('No time slots to clear');
                    return;
                }

                if (confirm('Are you sure you want to clear ALL time slots, including those synced with Jira?')) {
                    selectedEvents = [];
                    submittedEvents = [];
                    calendar.getEvents().forEach(event => event.remove());
                    updateEventSummary();
                    localStorage.removeItem('selectedEvents');
                    localStorage.removeItem('submittedEvents');
                }
            });

            function updateEventSummary() {
                const summaryDiv = document.getElementById('selectedEvents');
                const submittedDiv = document.getElementById('submittedEvents');

                // Filter events
                const unsubmittedEvents = selectedEvents.filter(event => !isEventSubmitted(event));
                const submittedEventsArray = selectedEvents.filter(event => isEventSubmitted(event));

                // Format time without seconds
                function formatTime(date) {
                    return date.toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }

                // Format duration in hours
                function formatDuration(minutes) {
                    const hours = minutes / 60;
                    return hours === Math.floor(hours) ?
                        `${hours}h` :
                        `${hours.toFixed(1).replace('.', ',')}h`;
                }

                // Update unsubmitted events summary
                if (unsubmittedEvents.length === 0) {
                    summaryDiv.innerHTML = '<div class="alert alert-info">No unsubmitted time slots selected</div>';
                } else {
                    summaryDiv.innerHTML = unsubmittedEvents.map(event => {
                        const start = new Date(event.start);
                        const end = new Date(event.end);
                        const duration = (end - start) / (1000 * 60); // Duration in minutes
                        return `
                            <div class="alert alert-info">
                                ${formatTime(start)} - ${formatTime(end)}
                                <br>
                                Duration: ${formatDuration(duration)}
                            </div>
                        `;
                    }).join('');

                    // Add a total duration summary for unsubmitted events
                    const totalMinutes = unsubmittedEvents.reduce((total, event) => {
                        const start = new Date(event.start);
                        const end = new Date(event.end);
                        return total + (end - start) / (1000 * 60);
                    }, 0);

                    summaryDiv.innerHTML += `
                        <div class="alert alert-primary">
                            <strong>Total:</strong> ${formatDuration(totalMinutes)}
                        </div>
                    `;
                }

                // Update submitted events summary
                if (submittedEventsArray.length === 0) {
                    submittedDiv.innerHTML = '<div class="alert alert-info">No submitted time slots</div>';
                } else {
                    submittedDiv.innerHTML = submittedEventsArray.map(event => {
                        const start = new Date(event.start);
                        const end = new Date(event.end);
                        const duration = (end - start) / (1000 * 60); // Duration in minutes
                        return `
                            <div class="alert alert-success">
                                ${formatTime(start)} - ${formatTime(end)}
                                <br>
                                Duration: ${formatDuration(duration)}
                            </div>
                        `;
                    }).join('');

                    // Add a total duration summary for submitted events
                    const totalSubmittedMinutes = submittedEventsArray.reduce((total, event) => {
                        const start = new Date(event.start);
                        const end = new Date(event.end);
                        return total + (end - start) / (1000 * 60);
                    }, 0);

                    submittedDiv.innerHTML += `
                        <div class="alert alert-success">
                            <strong>Total Submitted:</strong> ${formatDuration(totalSubmittedMinutes)}
                        </div>
                    `;
                }
            }

            document.getElementById('workLogForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                // Get credentials from storage
                const email = localStorage.getItem('jiraEmail') || sessionStorage.getItem('jiraEmail');
                const token = localStorage.getItem('jiraToken') || sessionStorage.getItem('jiraToken');
                const instance = localStorage.getItem('jiraInstance') || sessionStorage.getItem('jiraInstance') || 'foundever.atlassian.net';

                if (!email || !token) {
                    alert('Please set your Jira credentials first');
                    credentialsModal.show();
                    return;
                }

                if (selectedEvents.length === 0) {
                    alert('Please select at least one time slot');
                    return;
                }

                // Filter out already submitted events
                const newEvents = selectedEvents.filter(event => !isEventSubmitted(event));

                if (newEvents.length === 0) {
                    alert('All selected time slots have already been submitted');
                    return;
                }

                const issueKey = document.getElementById('issueKey').value;

                const eventsWithComments = newEvents.map(event => ({
                    ...event,
                    comment: ""
                }));

                document.querySelector('.loading').style.display = 'flex';

                try {
                    const response = await fetch('/api/log-work', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Jira-Email': email,
                            'X-Jira-Token': token,
                            'X-Jira-Instance': instance
                        },
                        body: JSON.stringify({
                            issueKey: issueKey,
                            events: eventsWithComments
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Add successfully submitted events to submittedEvents
                        submittedEvents.push(...newEvents);
                        saveSubmittedEvents();

                        // Update the calendar events to show as submitted
                        calendar.getEvents().forEach(event => {
                            if (newEvents.some(newEvent =>
                                    newEvent.start === event.startStr &&
                                    newEvent.end === event.endStr
                                )) {
                                event.setProp('backgroundColor', '#28a745');
                                event.setProp('borderColor', '#28a745');
                                event.setProp('classNames', ['submitted-time']);
                                event.setProp('title', '✓ Synced with Jira');
                            }
                        });

                        updateEventSummary();

                        const issueUrl = `https://${instance}/browse/${issueKey}`;
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        document.getElementById('issueLink').href = issueUrl;
                        document.getElementById('issueLink').textContent = issueUrl;
                        successModal.show();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error submitting work logs: ' + error.message);
                } finally {
                    document.querySelector('.loading').style.display = 'none';
                }
            });

            // Add view issue button functionality
            document.getElementById('viewIssueBtn').addEventListener('click', function() {
                const issueKey = document.getElementById('issueKey').value;
                if (!issueKey) {
                    alert('Please enter a Jira issue key');
                    return;
                }

                const instance = localStorage.getItem('jiraInstance') || sessionStorage.getItem('jiraInstance') || 'foundever.atlassian.net';
                const issueUrl = `https://${instance}/browse/${issueKey}`;
                window.open(issueUrl, '_blank');
            });
        });
    </script>
</body>

</html>