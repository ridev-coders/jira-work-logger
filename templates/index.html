<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Work Logger</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        #calendar {
            margin: 20px auto;
            padding: 0 10px;
            height: 700px;  /* Added fixed height */
        }
        .selected-time {
            background-color: #a8d5ff !important;
        }
        .submitted-time {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
        }
        .submitted-time .fc-event-title {
            padding: 2px 4px;
        }
        .event-summary {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center mt-4">Jira Work Logger</h1>
        
        <div class="row mt-4">
            <div class="col-md-2">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Calendar Settings</h5>
                        <div class="mb-3">
                            <label for="startTime" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="startTime" value="08:00">
                        </div>
                        <div class="mb-3">
                            <label for="endTime" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="endTime" value="19:00">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="devMode">
                            <label class="form-check-label" for="devMode">
                                Developer Mode
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div id="calendar"></div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Log Work</h5>
                        <form id="workLogForm">
                            <div class="mb-3">
                                <label for="issueKey" class="form-label">Jira Issue Key</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="issueKey" required value="AI-152">
                                    <a href="https://foundever.atlassian.net/browse/AI-152" class="btn btn-outline-secondary" target="_blank">
                                        View Issue
                                    </a>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" id="submitWork">Submit Work Logs</button>
                                <button type="button" class="btn btn-danger" id="clearAll">Clear Unsubmitted</button>
                                <button type="button" class="btn btn-danger d-none" id="clearEverything">Clear All (Including Synced)</button>
                            </div>
                        </form>
                        
                        <div class="event-summary mt-4">
                            <h6>Selected Time Slots</h6>
                            <div id="selectedEvents"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Success!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Work logs submitted successfully!</p>
                    <p>View the issue here: <a id="issueLink" href="#" target="_blank"></a></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedEvents = [];
            let submittedEvents = [];
            let devMode = false;
            
            const calendarEl = document.getElementById('calendar');
            let calendar;

            // Load saved time settings from localStorage
            function loadTimeSettings() {
                const savedStartTime = localStorage.getItem('workingHoursStart') || '08:00';
                const savedEndTime = localStorage.getItem('workingHoursEnd') || '19:00';
                
                document.getElementById('startTime').value = savedStartTime;
                document.getElementById('endTime').value = savedEndTime;
                
                return {
                    startTime: savedStartTime + ':00',
                    endTime: savedEndTime + ':00'
                };
            }

            // Save time settings to localStorage
            function saveTimeSettings(startTime, endTime) {
                localStorage.setItem('workingHoursStart', startTime);
                localStorage.setItem('workingHoursEnd', endTime);
            }

            // Save selected events to localStorage
            function saveSelectedEvents() {
                localStorage.setItem('selectedEvents', JSON.stringify(selectedEvents));
            }

            // Save submitted events to localStorage
            function saveSubmittedEvents() {
                localStorage.setItem('submittedEvents', JSON.stringify(submittedEvents));
            }

            // Load selected events from localStorage
            function loadSelectedEvents() {
                const savedEvents = localStorage.getItem('selectedEvents');
                if (savedEvents) {
                    const events = JSON.parse(savedEvents);
                    events.forEach(event => {
                        const isSubmitted = isEventSubmitted(event);
                        calendar.addEvent({
                            start: event.start,
                            end: event.end,
                            display: 'block',
                            backgroundColor: isSubmitted ? '#28a745' : '#a8d5ff',
                            borderColor: isSubmitted ? '#28a745' : '#a8d5ff',
                            classNames: isSubmitted ? ['submitted-time'] : ['selected-time'],
                            title: isSubmitted ? '✓ Synced with Jira' : '',
                            editable: false
                        });
                    });
                    selectedEvents = events;
                    updateEventSummary();
                }
            }

            // Load submitted events from localStorage
            function loadSubmittedEvents() {
                const savedSubmittedEvents = localStorage.getItem('submittedEvents');
                if (savedSubmittedEvents) {
                    submittedEvents = JSON.parse(savedSubmittedEvents);
                }
            }

            // Check if an event has been submitted
            function isEventSubmitted(event) {
                return submittedEvents.some(submittedEvent => 
                    submittedEvent.start === event.start && 
                    event.end === submittedEvent.end
                );
            }

            function initializeCalendar(startTime, endTime) {
                if (calendar) {
                    calendar.destroy();
                }
                
                calendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'timeGridWeek,timeGridDay'
                    },
                    initialView: 'timeGridWeek',
                    slotMinTime: startTime,
                    slotMaxTime: endTime,
                    allDaySlot: false,
                    selectable: true,
                    selectMirror: true,
                    nowIndicator: true,
                    height: 'auto',
                    expandRows: true,
                    businessHours: {
                        daysOfWeek: [1, 2, 3, 4, 5],
                        startTime: startTime,
                        endTime: endTime,
                    },
                    scrollTime: startTime,
                    slotDuration: '00:30:00',
                    select: function(info) {
                        const event = {
                            start: info.startStr,
                            end: info.endStr,
                            display: 'block',
                            backgroundColor: '#a8d5ff',
                            borderColor: '#a8d5ff',
                            classNames: ['selected-time'],
                            title: '',
                            editable: false
                        };
                        calendar.addEvent(event);
                        selectedEvents.push(event);
                        updateEventSummary();
                        saveSelectedEvents();
                    },
                    eventClick: function(info) {
                        if (info.event.classNames.includes('selected-time')) {
                            selectedEvents = selectedEvents.filter(e => 
                                e.start !== info.event.startStr || 
                                e.end !== info.event.endStr
                            );
                            info.event.remove();
                            updateEventSummary();
                            saveSelectedEvents();
                        }
                    },
                    eventDidMount: function(info) {
                        if (info.event.classNames.includes('selected-time')) {
                            info.el.style.backgroundColor = '#a8d5ff';
                            info.el.style.borderColor = '#a8d5ff';
                        } else if (info.event.classNames.includes('submitted-time')) {
                            info.el.style.backgroundColor = '#28a745';
                            info.el.style.borderColor = '#28a745';
                        }
                    }
                });
                
                calendar.render();
                loadSelectedEvents();
            }

            // Load developer mode setting from localStorage
            function loadDevMode() {
                const savedDevMode = localStorage.getItem('devMode') === 'true';
                document.getElementById('devMode').checked = savedDevMode;
                devMode = savedDevMode;
                document.getElementById('clearEverything').classList.toggle('d-none', !devMode);
            }

            // Save developer mode setting to localStorage
            function saveDevMode(enabled) {
                localStorage.setItem('devMode', enabled);
                devMode = enabled;
                document.getElementById('clearEverything').classList.toggle('d-none', !enabled);
            }

            // Load saved settings and initialize calendar
            const savedTimes = loadTimeSettings();
            loadSubmittedEvents();
            loadDevMode();
            initializeCalendar(savedTimes.startTime, savedTimes.endTime);

            // Update time change listeners to save automatically
            document.getElementById('startTime').addEventListener('change', function() {
                const startTime = this.value;
                const endTime = document.getElementById('endTime').value;
                saveTimeSettings(startTime, endTime);
                initializeCalendar(startTime + ':00', endTime + ':00');
            });

            document.getElementById('endTime').addEventListener('change', function() {
                const startTime = document.getElementById('startTime').value;
                const endTime = this.value;
                saveTimeSettings(startTime, endTime);
                initializeCalendar(startTime + ':00', endTime + ':00');
            });

            // Add developer mode toggle listener
            document.getElementById('devMode').addEventListener('change', function() {
                saveDevMode(this.checked);
            });

            // Update clear unsubmitted functionality
            document.getElementById('clearAll').addEventListener('click', function() {
                const unsubmittedEvents = selectedEvents.filter(event => !isEventSubmitted(event));
                
                if (unsubmittedEvents.length === 0) {
                    alert('No unsubmitted time slots to clear');
                    return;
                }
                
                if (confirm('Are you sure you want to clear all unsubmitted time slots?')) {
                    // Remove unsubmitted events from the calendar
                    calendar.getEvents().forEach(event => {
                        if (event.classNames.includes('selected-time')) {
                            event.remove();
                        }
                    });

                    // Filter out unsubmitted events from selectedEvents
                    selectedEvents = selectedEvents.filter(event => isEventSubmitted(event));
                    saveSelectedEvents();
                    updateEventSummary();
                }
            });

            // Add clear everything button listener (dev mode)
            document.getElementById('clearEverything').addEventListener('click', function() {
                if (selectedEvents.length === 0) {
                    alert('No time slots to clear');
                    return;
                }
                
                if (confirm('Are you sure you want to clear ALL time slots, including those synced with Jira?')) {
                    selectedEvents = [];
                    submittedEvents = [];
                    calendar.getEvents().forEach(event => event.remove());
                    updateEventSummary();
                    localStorage.removeItem('selectedEvents');
                    localStorage.removeItem('submittedEvents');
                }
            });

            function updateEventSummary() {
                const summaryDiv = document.getElementById('selectedEvents');
                summaryDiv.innerHTML = selectedEvents.map(event => {
                    const start = new Date(event.start);
                    const end = new Date(event.end);
                    const duration = (end - start) / (1000 * 60); // Duration in minutes
                    const isSubmitted = isEventSubmitted(event);
                    return `
                        <div class="alert ${isSubmitted ? 'alert-success' : 'alert-info'}">
                            ${start.toLocaleTimeString()} - ${end.toLocaleTimeString()}
                            <br>
                            Duration: ${duration} minutes
                            ${isSubmitted ? '<br><small class="text-muted">(Already submitted)</small>' : ''}
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('workLogForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (selectedEvents.length === 0) {
                    alert('Please select at least one time slot');
                    return;
                }

                // Filter out already submitted events
                const newEvents = selectedEvents.filter(event => !isEventSubmitted(event));

                if (newEvents.length === 0) {
                    alert('All selected time slots have already been submitted');
                    return;
                }

                const issueKey = document.getElementById('issueKey').value;

                const eventsWithComments = newEvents.map(event => ({
                    ...event,
                    comment: ""
                }));

                document.querySelector('.loading').style.display = 'flex';

                try {
                    const response = await fetch('/api/log-work', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            issueKey: issueKey,
                            events: eventsWithComments
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Add successfully submitted events to submittedEvents
                        submittedEvents.push(...newEvents);
                        saveSubmittedEvents();
                        
                        // Update the calendar events to show as submitted
                        calendar.getEvents().forEach(event => {
                            if (newEvents.some(newEvent => 
                                newEvent.start === event.startStr && 
                                newEvent.end === event.endStr
                            )) {
                                event.setProp('backgroundColor', '#28a745');
                                event.setProp('borderColor', '#28a745');
                                event.setProp('classNames', ['submitted-time']);
                                event.setProp('title', '✓ Synced with Jira');
                            }
                        });
                        
                        updateEventSummary();

                        const issueUrl = `https://foundever.atlassian.net/browse/${issueKey}`;
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        document.getElementById('issueLink').href = issueUrl;
                        document.getElementById('issueLink').textContent = issueUrl;
                        successModal.show();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error submitting work logs: ' + error.message);
                } finally {
                    document.querySelector('.loading').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>